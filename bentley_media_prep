#!/usr/bin/env python3
"""
bentley_media_prep - Extract and resize FLAC cover art to JPEG files

Recursively processes directories containing FLAC files:
- Extracts cover art from the first FLAC in each folder
- Resizes to max 800px (longest side), maintains aspect ratio, no upscaling
- Saves as high-quality JPEG (quality 95)

Special handling for personal compilations (folders starting with _):
- Strips _ from folder name to create album name
- Updates all FLAC files with: ALBUM=folder name, ALBUMARTIST=Various Artists, COMPILATION=1
- Only creates cover art if it doesn't already exist

Regular albums:
- No metadata changes
- Always creates/overwrites cover art
"""

import argparse
import os
import sys
from datetime import datetime
from pathlib import Path
from io import BytesIO

try:
    from mutagen.flac import FLAC
    from PIL import Image
except ImportError as e:
    print(f"ERROR: Missing required library: {e}")
    print("Please install required packages:")
    print("  pip install mutagen Pillow")
    sys.exit(1)


def log(message):
    """Log message with timestamp"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"[{timestamp}] {message}")


def update_compilation_metadata(flac_files, album_name):
    """
    Update metadata for personal compilation tracks
    
    Args:
        flac_files: List of Path objects pointing to FLAC files
        album_name: Album name to set for all tracks
        
    Returns:
        Number of files successfully updated
    """
    updated_count = 0
    
    for flac_path in flac_files:
        try:
            audio = FLAC(flac_path)
            
            # Set compilation metadata
            audio['ALBUM'] = album_name
            audio['ALBUMARTIST'] = 'Various Artists'
            audio['COMPILATION'] = '1'
            # ARTIST is preserved (not modified)
            
            audio.save()
            updated_count += 1
            log(f"    Updated: {flac_path.name}")
            
        except Exception as e:
            log(f"    ERROR: Failed to update {flac_path.name}: {e}")
    
    return updated_count


def extract_cover_art(flac_path):
    """
    Extract cover art from FLAC file
    
    Args:
        flac_path: Path to FLAC file
        
    Returns:
        PIL Image object or None if no cover art found
    """
    try:
        audio = FLAC(flac_path)
        
        if not audio.pictures:
            return None
            
        # Get the first picture (usually front cover)
        picture = audio.pictures[0]
        image = Image.open(BytesIO(picture.data))
        return image
        
    except Exception as e:
        log(f"ERROR: Failed to extract cover art from {flac_path}: {e}")
        return None


def resize_and_save(image, output_path, max_size=800, quality=95):
    """
    Resize image maintaining aspect ratio and save as JPEG
    
    Args:
        image: PIL Image object
        output_path: Path to save JPEG
        max_size: Maximum dimension for longest side (default 800)
        quality: JPEG quality (1-95)
    """
    try:
        # Convert to RGB if necessary (JPEG doesn't support transparency)
        if image.mode in ('RGBA', 'LA', 'P'):
            rgb_image = Image.new('RGB', image.size, (255, 255, 255))
            if image.mode == 'P':
                image = image.convert('RGBA')
            rgb_image.paste(image, mask=image.split()[-1] if image.mode in ('RGBA', 'LA') else None)
            image = rgb_image
        elif image.mode != 'RGB':
            image = image.convert('RGB')
        
        # Calculate new size maintaining aspect ratio
        width, height = image.size
        
        # Only resize if image is larger than max_size
        if width <= max_size and height <= max_size:
            # No resize needed - image is already within bounds
            resized = image
            log(f"  No resize needed (original size within {max_size}x{max_size})")
        else:
            # Calculate scaling to fit within max_size while maintaining aspect ratio
            if width > height:
                new_width = max_size
                new_height = int(height * (max_size / width))
            else:
                new_height = max_size
                new_width = int(width * (max_size / height))
            
            resized = image.resize((new_width, new_height), Image.Resampling.LANCZOS)
            log(f"  Resized from {width}x{height} to {new_width}x{new_height}")
        
        # Save as JPEG
        resized.save(output_path, 'JPEG', quality=quality, optimize=True)
        log(f"SUCCESS: Created {output_path}")
        
    except Exception as e:
        log(f"ERROR: Failed to save image to {output_path}: {e}")


def process_directory(root_dir, jpeg_name):
    """
    Recursively process directory tree, extracting cover art from FLAC files
    and updating metadata for personal compilations (folders starting with _)
    
    Args:
        root_dir: Root directory to process
        jpeg_name: Output JPEG filename
    """
    root_path = Path(root_dir).resolve()
    
    if not root_path.exists():
        log(f"ERROR: Directory does not exist: {root_dir}")
        sys.exit(1)
        
    if not root_path.is_dir():
        log(f"ERROR: Path is not a directory: {root_dir}")
        sys.exit(1)
    
    log(f"Starting processing of: {root_path}")
    log(f"Output filename: {jpeg_name}")
    log(f"Target size: Max 800px (longest side), maintain aspect ratio, no upscaling")
    log(f"Quality: 95")
    log("-" * 80)
    
    folders_with_flac = 0
    compilations_processed = 0
    compilations_skipped = 0
    regular_albums_processed = 0
    images_created = 0
    images_overwritten = 0
    
    # Walk the directory tree
    for dirpath, dirnames, filenames in os.walk(root_path):
        # Skip hidden directories
        dirnames[:] = [d for d in dirnames if not d.startswith('.')]
        
        # Find FLAC files in current directory
        flac_files = [f for f in filenames if f.lower().endswith('.flac')]
        
        if not flac_files:
            continue
            
        folders_with_flac += 1
        current_dir = Path(dirpath)
        folder_name = current_dir.name
        output_path = current_dir / jpeg_name
        
        # Check if this is a personal compilation (starts with _)
        is_compilation = folder_name.startswith('_')
        
        if is_compilation:
            # Personal compilation - strip _ and update metadata
            album_name = folder_name[1:]  # Remove leading _
            log(f"Processing PERSONAL COMPILATION: {current_dir}")
            log(f"  Album name: {album_name}")
            log(f"  Found {len(flac_files)} FLAC file(s)")
            
            # Update metadata for all FLAC files
            log(f"  Updating metadata for all tracks...")
            flac_paths = [current_dir / f for f in flac_files]
            updated = update_compilation_metadata(flac_paths, album_name)
            log(f"  Updated {updated}/{len(flac_files)} track(s)")
            
            # Count as processed (we updated metadata)
            compilations_processed += 1
            
            # Check if cover art already exists
            if output_path.exists():
                log(f"  Skipping cover art extraction (file exists): {jpeg_name}")
                compilations_skipped += 1
                log("")
                continue
        else:
            # Regular album
            log(f"Processing REGULAR ALBUM: {current_dir}")
            log(f"  Found {len(flac_files)} FLAC file(s)")
            regular_albums_processed += 1
        
        # Extract and save cover art
        first_flac = current_dir / flac_files[0]
        log(f"  Extracting cover art from: {first_flac.name}")
        
        # Extract cover art
        image = extract_cover_art(first_flac)
        
        if image is None:
            log(f"  WARNING: No cover art found in {first_flac.name}")
            log("")
            continue
        
        original_size = image.size
        log(f"  Original cover art size: {original_size[0]}x{original_size[1]}")
        
        # Track if we're overwriting
        overwriting = output_path.exists()
        
        # Save resized image
        resize_and_save(image, output_path)
        
        if overwriting:
            images_overwritten += 1
        else:
            images_created += 1
        
        log("")
    
    # Summary
    log("-" * 80)
    log("Processing complete!")
    log(f"Folders with FLAC files: {folders_with_flac}")
    log(f"Personal compilations processed: {compilations_processed}")
    log(f"Personal compilations skipped (cover art exists): {compilations_skipped}")
    log(f"Regular albums processed: {regular_albums_processed}")
    log(f"Images created (new): {images_created}")
    log(f"Images overwritten (existing): {images_overwritten}")


def main():
    """Main entry point"""
    parser = argparse.ArgumentParser(
        description="Extract and resize FLAC cover art to JPEG files with personal compilation support",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Personal Compilations (folders starting with _):
  - Strip _ from folder name to create album name
  - Update metadata: ALBUM, ALBUMARTIST=Various Artists, COMPILATION=1
  - Only create cover art if it doesn't exist
  
Regular Albums:
  - No metadata changes
  - Always create/overwrite cover art
  
Cover art processing:
  - Resize to max 800px (longest side)
  - Maintain aspect ratio, no upscaling
  - JPEG quality 95

Examples:
  bentley_media_prep /path/to/music
  bentley_media_prep /path/to/music album_art.jpg
  bentley_media_prep ~/Music/FLAC folder.jpg
  
  Folder "_Road Trip 2024" becomes album "Road Trip 2024" with Various Artists
        """
    )
    
    parser.add_argument(
        'directory',
        help='Root directory to process (will recurse through all subdirectories)'
    )
    
    parser.add_argument(
        'jpeg_name',
        nargs='?',
        default='cover.jpg',
        help='Output JPEG filename (default: cover.jpg)'
    )
    
    args = parser.parse_args()
    
    try:
        process_directory(args.directory, args.jpeg_name)
    except KeyboardInterrupt:
        log("\nINTERRUPTED: Processing cancelled by user")
        sys.exit(130)
    except Exception as e:
        log(f"FATAL ERROR: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()
